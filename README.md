# Sogni Photobooth

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)](CONTRIBUTING.md)

An "AI photobooth" web app that allows users to snap a selfie or upload a photo via desktop or mobile, then quickly generate a series of stylised portraits without having to download AI models or have a powerful GPU. This is a demo application powered by the whitelabel Sogni Client SDK and open-sourced to give developers a solid example to fork or reference for their own Sogni Supernet powered applications.

If you build something cool with the Sogni Client SDK let us know and we'll add it to the growing list of "Sogni Superapps": https://www.sogni.ai/super-apps

Live demo ‚Üí **https://photobooth.sogni.ai**

<div align="center">
  <img alt="Photobooth screenshot ‚Äì webcam mode" src="docs/assets/photobooth-demo-1.png?1" width="100%"/>
  <img alt="Photobooth screenshot ‚Äì style selection"  src="docs/assets/photobooth-demo-2.png?1" width="100%"/>
  <img alt="Photobooth screenshot ‚Äì generated gallery"  src="docs/assets/photobooth-demo-3.png?1" width="100%"/>
</div>

---

## ‚ú® Features
- **State-of-the-art Character Transfer / Identity-Preserving Stylized Synthesis** ‚Äì keeps your face while transforming the style.
- **Mobile & Desktop** ‚Äì webcam support, camera-roll upload, drag-and-drop.
- **One-Click Local Dev** ‚Äì Vite + Nodemon + script runner.
- **Style Presets & Customization** - Pick between 150+ style prompts or write your own. Pick different models and customize model guidance settings.
- **DePIN Powered** ‚Äì no model downloads or local GPU needed; up to 64 concurrent jobs on the Sogni Supernet.
- **Secure Backend** ‚Äì credentials live only in the Node server; the browser never sees them.
- **Live Progress** ‚Äì real-time SSE and per-image progress bars.
- **üí≥ Stripe Payment Integration** ‚Äì Purchase Spark Points directly in the app with credit card payments (authenticated users only).

> You'll need a free [Sogni account](https://www.sogni.ai) + tokens for inference jobs.

---

## üìë Table of Contents
1. [Quick Start](#-quick-start)
2. [Project Layout](#-project-layout)
3. [Configuration](#Ô∏è-configuration)
4. [Stripe Payment Integration](#-stripe-payment-integration)
5. [Code Quality & Enforcement](#-code-quality--enforcement)
6. [Testing](#-testing)
7. [Production Build & Deploy](#-production-build--deploy)
8. [Contributing](#-contributing)
9. [License](#-license)
10. [Acknowledgements](#-acknowledgements)

---

## üöÄ Quick Start

### 1 ¬∑ Clone & install
```bash
# clone
git clone https://github.com/Sogni-AI/sogni-photobooth.git
cd sogni-photobooth

# installs root deps *and* runs the npm **prepare** script which installs /server deps
npm install
```

### 2 ¬∑ Backend credentials
```bash
cp server/.env.example server/.env   # edit the values
```
Minimal example:
```
SOGNI_APP_ID=photobooth-local   # optional; autogenerated if blank
SOGNI_USERNAME=your_username
SOGNI_PASSWORD=your_password
SOGNI_ENV=local                # local | staging | production
PORT=3001
CLIENT_ORIGIN=https://photobooth-local.sogni.ai

# Redis Configuration (optional, for Analytics, improved session management, Twitter/X sharing)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB_INDEX=1
REDIS_VERBOSE_LOGGING=true
```

### 3 ¬∑ Configure Local Hosts & SSL Certificate

For the best local development experience, we use Nginx as a reverse proxy to handle SSL and route traffic to the appropriate services (frontend and backend) on separate subdomains.

**a. Update your hosts file:**
   You\'ll need to map the local development domains to your loopback address. Add the following lines to your `/etc/hosts` file (or equivalent for your OS):

   ```
   127.0.0.1 photobooth-local.sogni.ai
   127.0.0.1 photobooth-api-local.sogni.ai
   ```

**b. Create SSL Certificates:**
   The Nginx configuration requires SSL certificates for both domains. Create them with this one-liner:

   ```bash
   # Create SSL directory and generate self-signed certificate
   mkdir -p /opt/homebrew/etc/nginx/ssl && \
   cd /opt/homebrew/etc/nginx/ssl && \
   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout sogni-local.key \
     -out sogni-local.crt \
     -subj "/C=US/ST=State/L=City/O=Development/CN=*.sogni.ai" \
     -addext "subjectAltName=DNS:photobooth-local.sogni.ai,DNS:photobooth-api-local.sogni.ai,DNS:*.sogni.ai"
   ```

   This creates certificates at:
   - `/opt/homebrew/etc/nginx/ssl/sogni-local.crt`
   - `/opt/homebrew/etc/nginx/ssl/sogni-local.key`

   **Browser Certificate Warning:** When you first visit https://photobooth-local.sogni.ai, your browser will show a security warning about the self-signed certificate. Click **"Advanced"** ‚Üí **"Proceed"** to continue. This is normal for local development.

   *Optional: To trust the certificate system-wide and avoid the warning:*
   ```bash
   sudo security add-trusted-cert -d -r trustRoot \
     -k /Library/Keychains/System.keychain \
     /opt/homebrew/etc/nginx/ssl/sogni-local.crt
   # Restart your browser after running this
   ```

### 4 ¬∑ Configure Nginx and Run in dev mode

Before starting the development servers, ensure Nginx is running and configured to use the local setup.

**a. Configure Nginx:**
   Copy the provided Nginx configuration file from this project to your Nginx server configuration directory. A common location for Homebrew Nginx is `/opt/homebrew/etc/nginx/servers/`.

   ```bash
   # Run from the project root directory
   cp scripts/nginx/local.conf /opt/homebrew/etc/nginx/servers/photobooth-local.conf
   ```

**b. Start/Restart Nginx:**
   Start Nginx to apply the configuration. You'll need to enter your password:

   ```bash
   # Start Nginx (if not running)
   sudo nginx

   # Or restart if already running
   sudo nginx -s reload
   ```

   Verify Nginx is running:
   ```bash
   ps aux | grep nginx | grep -v grep
   ```

**c. Run Development Servers:**
   Now, start the React front-end and the Node Express back-end in separate terminals.

```bash
# Terminal 1 ‚Äì backend
cd server && npm run dev

# Terminal 2 ‚Äì frontend (in project root)
npm run dev
```

**d. Access the Application:**
   Visit **https://photobooth-local.sogni.ai**. The frontend will make API calls to **https://photobooth-api-local.sogni.ai**.

   *Note: Your browser will show a security warning about the self-signed certificate. Click "Advanced" ‚Üí "Proceed" to continue (see Step 3b above).*

### Optional script runner

If you prefer not to keep terminals open, you can use the script runner. This will start the services in the background and log to files in the
`logs/` directory.

```bash
./scripts/run.sh start   # starts front & back in background
./scripts/run.sh status  # see logs / ports
```

### Troubleshooting Local Setup

**"This site can't be reached" / ERR_CONNECTION_REFUSED:**
- Make sure both frontend (port 5175) and backend (port 3001) are running
- Verify Nginx is running: `ps aux | grep nginx | grep -v grep`
- If Nginx isn't running, start it: `sudo nginx`
- Check that SSL certificates exist: `ls -la /opt/homebrew/etc/nginx/ssl/`

**ERR_CERT_AUTHORITY_INVALID:**
- This is expected with self-signed certificates
- Click "Advanced" ‚Üí "Proceed" in your browser
- Or trust the certificate system-wide (see Step 3b above)

**Port already in use:**
- The `npm run dev` commands automatically kill processes on ports 5175 and 3001
- If you see errors, manually kill the processes: `npx kill-port 5175 3001`

---

## üóÇ Project Layout
```
‚îú‚îÄ src/           # React frontend
‚îÇ  ‚îú‚îÄ components/
‚îÇ  ‚îú‚îÄ services/   # browser-side API helpers
‚îÇ  ‚îî‚îÄ ...
‚îú‚îÄ server/        # Express backend (API ‚Üí Sogni SDK)
‚îÇ  ‚îú‚îÄ routes/
‚îÇ  ‚îî‚îÄ services/
‚îú‚îÄ scripts/       # helper CLI & deployment scripts
‚îú‚îÄ tests/         # Playwright visual tests & Jest unit tests
‚îî‚îÄ screenshots/   # demo images used in this README
```

---

## ‚öôÔ∏è Configuration

| File | Purpose |
|------|---------|
| `server/.env` | Backend secrets, CORS origin, Redis configuration |
| `.env.local` | Local frontend configuration including Google Analytics settings |
| `.env.staging` | Staging frontend configuration for builds |
| `.env.production` | Production frontend configuration for builds |
| `configs/local/*.conf` | Nginx local SSL reverse-proxy |
| `scripts/nginx/local.conf` | Main Nginx configuration for local development, defining frontend and backend subdomains. Expects SSL certs at `/opt/homebrew/etc/nginx/ssl/`. |

### Frontend Environment Variables

The application uses environment-specific configuration files for frontend settings:

1. Create a `.env.local` file in the project root for local development:
   ```
   # Moderation Password (Required)
   # Used to protect the /admin/moderate page
   VITE_MODERATION_PASSWORD=your_secure_password_here

   # Moderation Feature Flag (Optional)
   # Set to 'false' to disable moderation for rapid testing
   VITE_MODERATION_ENABLED=false

   # Google Analytics Configuration (Optional)
   # Set to 'false' to disable GA completely
   VITE_GA_ENABLED=true
   # Your Google Analytics measurement ID (e.g., G-XXXXXXXXXX)
   VITE_GA_MEASUREMENT_ID=G-XXXXXXXXXX
   # Domain for cookies, set to 'auto' for default behavior or specify 'sogni.ai' to share across subdomains
   VITE_GA_DOMAIN=sogni.ai
   ```

2. For production builds, create a `.env.production` file with the same variables (set `VITE_MODERATION_ENABLED=true` for production)

3. Important notes:
   - **Never commit `.env.local` or `.env.production` to Git** - they're in `.gitignore`
   - All frontend environment variables must be prefixed with `VITE_` to be accessible
   - The moderation password is required to access `/admin/moderate`
   - Moderation is enabled by default in production/staging, disabled by default in local
   - Google Analytics is optional and respects user privacy
   - Analytics supports cross-subdomain tracking for sogni.ai domains

### Redis Configuration

The application utilizes Redis for session management and persistence of Twitter/X OAuth data when using the photo sharing functionality:

1. Add these Redis configuration variables to your `server/.env` file:
   ```
   # Redis Configuration
   REDIS_HOST=localhost
   REDIS_PORT=6379
   REDIS_PASSWORD=
   REDIS_DB_INDEX=1
   REDIS_VERBOSE_LOGGING=true
   ```

2. Redis benefits:
   - Provides persistent session storage for Twitter/X OAuth flow
   - Falls back to in-memory storage if Redis is unavailable
   - Automatically handles TTL (Time-To-Live) for session data
   - Improves scalability when deploying to multiple server instances

Redis is optional - if not available, the system will use in-memory storage as a fallback.

---

## üí≥ Stripe Payment Integration

The photobooth now supports credit card payments via Stripe for purchasing Spark Points. This feature allows authenticated users to buy credits directly within the app.

### Features
- **Beautiful Payment Modal** - Gradient backgrounds, smooth animations, responsive design
- **Real-time Balance Updates** - WebSocket-powered balance updates via SDK's DataEntity pattern (no polling!)
- **Cross-tab Notifications** - BroadcastChannel for purchase completion messages
- **Direct API Integration** - Calls Sogni API directly via authenticated SDK (same as sogni-web)
- **Mobile Optimized** - Works seamlessly on mobile and desktop

### Architecture
```
Photobooth Frontend ‚Üí Sogni API (via SDK) ‚Üí Stripe
                   ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê
```
*Calls Sogni API directly using the authenticated SogniClient SDK (same as sogni-web)*

### User Flow
1. User clicks "Buy Spark" in wallet widget OR triggers "Out of Credits" popup
2. StripePurchase modal shows available Spark Point packages
3. User selects a package and clicks "Buy"
4. Stripe Checkout opens in new window/tab
5. User completes payment with credit card
6. Stripe redirects to success page `/spark-purchase-complete/`
7. Success page broadcasts purchase completion to main app
8. Stripe webhook updates backend, credits are added to user account
9. **Balance updates automatically via WebSocket** (SDK's DataEntity 'updated' event)
10. UI displays new balance in real-time

### Backend Changes Required

The Sogni API backend needs updates to support photobooth redirects. See `STRIPE_INTEGRATION.md` for complete implementation details:

**Key changes needed in `../sogni-api`:**
1. Add `getPhotoboothBaseUrl()` helper function
2. Update `StripeService.getRedirectUrl()` to support `redirectType: 'photobooth'`
3. Update TypeScript interfaces to include `'photobooth'` redirect type

### Testing

Use Stripe test cards:
- **Success**: `4242 4242 4242 4242`
- **Decline**: `4000 0000 0000 0002`
- Use any future expiry date and any 3-digit CVC

### Files
- **Frontend**: `src/components/stripe/*`, `src/services/stripe.ts`, `src/hooks/useSparkPurchase.ts`
- **Success Page**: `public/spark-purchase-complete/index.html`
- **Documentation**: `STRIPE_INTEGRATION.md`

*No backend proxy needed - calls Sogni API directly via SDK*

### Limitations
- Only available for **authenticated users** (not demo mode)
- Requires backend changes in `../sogni-api` to be deployed
- Webhook endpoint must be configured in Stripe dashboard

For complete implementation details, troubleshooting, and deployment guide, see **[STRIPE_INTEGRATION.md](./STRIPE_INTEGRATION.md)**.

---

## üîç Code Quality & Enforcement

This project uses **automated validation** to prevent common React bugs, especially around `useEffect` hooks.

### useEffect Validation

**Before making changes to React components:**

```bash
npm run validate:useeffect
```

This script scans all React files for common `useEffect` violations:
- ‚ùå Functions in dependency arrays (causes infinite re-renders)
- ‚ùå Too many dependencies (indicates mixed concerns)
- ‚ùå Context functions that don't need to be dependencies

**Required reading:**
- üìñ `cursor.rules.md` - Complete rules and examples
- üìã `USEEFFECT-CHECKLIST.md` - Step-by-step checklist before editing useEffect
- üìä `USEEFFECT-ENFORCEMENT.md` - Full enforcement strategy and rationale

**Why this matters:**

A single misplaced dependency can cause bugs like:
- Settings that auto-deselect after being clicked
- Infinite render loops
- Effects running when unrelated state changes
- Performance degradation from unnecessary re-renders

The validation script catches these issues **before** they make it into the codebase.

---

## üß™ Testing

```bash
# unit + component tests
npm test

# visual regression (HTML report)
npm run test:visual
```
Full visual refactor workflow:
```bash
npm run test:visual:baseline  # capture
# ‚Ä¶make changes‚Ä¶
npm run test:visual:refactor  # compare & report
```

---

## üì¶ Production Build & Deploy

```bash
# Build for production
npm run build            # Uses .env.production for frontend config

# Build for staging
npm run build:staging    # Uses .env.staging for frontend config

# Deploy to production (requires server/.env.production)
npm run deploy:production

# Deploy to staging (requires server/.env.staging and .env.staging)
npm run deploy:staging
```

Deploy `/dist` to your static host and `/server` behind Node (PM2, systemd, etc.).  
Make sure **PORT**, **CLIENT_ORIGIN**, **Redis configuration** (if using Twitter sharing), and SSL are configured.

---

## ü§ù Contributing
Pull requests are welcome!  
Please run `npm run lint` and `npm run test:visual` before submitting.

We follow the standard [Contributor Covenant](https://www.contributor-covenant.org/version/2/1/code_of_conduct/) Code of Conduct.

---

## üìú License

Licensed under the **MIT License**.  See [`LICENSE`](LICENSE) for the full text.

---

## üôè Acknowledgements
- **Sogni AI** ‚Äì for the SDK & Supernet that powers this application. [More "Superapps"](https://www.sogni.ai/super-apps)
- **Stable Diffusion SDXL** ‚Äì <https://huggingface.co/docs/diffusers/en/using-diffusers/sdxl>
- **ControlNet** ‚Äì <https://github.com/lllyasviel/ControlNet>
- **Instant ID** ‚Äì <https://github.com/instantX-research/InstantID>
- **Cursor AI** ‚Äì the AI pair-programmer used to vibe-code this sample repo.

For questions, feedback, or support feel free to reach us at **dream@sogni.ai** 
